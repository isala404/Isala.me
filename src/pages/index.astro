---
import BaseLayout from '../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';
import {
  name,
  title,
  tagline,
  bio,
  contact,
  experience,
  projects,
  nowTiles,
  quotes,
  footerJokes,
  speaking,
} from '../lib/profile';
import { getThemeColors, darkenHex } from '../lib/theme';
import { Headphones, Coffee, Tv, Flame, Cpu, Laptop, Rocket } from 'lucide-astro';

const blogPosts = (await getCollection('blog', ({ data }) => !data.draft && data.featured)).sort(
  (a, b) => b.data.publishedAt.valueOf() - a.data.publishedAt.valueOf()
);

const notes = (await getCollection('notes', ({ data }) => !data.draft && data.featured)).sort(
  (a, b) => b.data.publishedAt.valueOf() - a.data.publishedAt.valueOf()
);

const iconMap: Record<string, any> = {
  Headphones,
  Coffee,
  Tv,
  Flame,
  Cpu,
  Laptop,
  Rocket,
};

function formatDate(date: Date): string {
  return date.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
}

const theme = getThemeColors();
const githubChartColor = darkenHex(theme.accent, 0.8);
const githubUsername = 'isala404';
---

<BaseLayout title="Isala Piyarisi | Platform Engineer · eBPF · AI Infrastructure">
  <main class="max-w-content relative z-10 mx-auto px-6 py-16 md:py-24">
    <!-- Hero Section -->
    <header class="mb-12">
      <div class="flex items-start justify-between gap-4">
        <div>
          <h1
            class="text-theme-text relative mb-2 text-3xl font-semibold tracking-tight md:text-4xl"
          >
            <span id="name-text" class="name-clickable">{name}</span>
            <span id="name-tooltip" class="name-tooltip"></span>
          </h1>
          <p class="text-theme-text-secondary mb-4 text-lg font-medium">
            {title}
            <span class="whitespace-nowrap">· {tagline}</span>
          </p>
        </div>
        <div class="dog-container h-20 w-20 flex-shrink-0 md:h-24 md:w-24">
          <img src="/dog-still.png" alt="A cute golden retriever" class="dog-still" />
          <div class="dog-sprite" aria-hidden="true"></div>
        </div>
      </div>
      <nav class="mb-6 flex items-center gap-4 text-sm font-medium">
        <a
          href={`mailto:${contact.email}`}
          class="text-theme-accent hover:text-theme-accent-hover transition-colors"
          title={contact.email}
          data-umami-event="contact-email">em</a
        >
        <span class="text-theme-text-secondary">·</span>
        <a
          href={contact.github}
          class="text-theme-accent hover:text-theme-accent-hover transition-colors"
          data-umami-event="contact-github">gh</a
        >
        <span class="text-theme-text-secondary">·</span>
        <a
          href={contact.twitter}
          class="text-theme-accent hover:text-theme-accent-hover transition-colors"
          data-umami-event="contact-twitter">x</a
        >
        <span class="text-theme-text-secondary">·</span>
        <a
          href={contact.linkedin}
          class="text-theme-accent hover:text-theme-accent-hover transition-colors"
          data-umami-event="contact-linkedin">li</a
        >
      </nav>
      <p class="text-theme-text mb-4 max-w-prose text-base leading-relaxed">
        {bio}
      </p>
      <p>
        <a
          href="/about/"
          class="text-theme-text-secondary arrow-link text-sm"
          data-umami-event="read-more"
          data-umami-event-section="about"
        >
          <span class="arrow">→</span><span class="text">the long version</span>
        </a>
      </p>
    </header>

    <!-- Now Grid -->
    <section class="mb-12">
      <div class="now-grid grid grid-cols-2 gap-3 md:grid-cols-3">
        {
          nowTiles.map((tile) => {
            const Icon = iconMap[tile.icon];
            const Tag = tile.link ? 'a' : 'div';
            return (
              <Tag
                href={tile.link}
                target={tile.link ? '_blank' : undefined}
                data-tile={tile.id}
                class="now-tile group border-theme-border bg-theme-card/30 hover:bg-theme-card hover:border-theme-border-hover rounded-lg border p-4 transition-all"
                data-umami-event={`now-tile-${tile.id}`}
                data-umami-event-title={tile.title}
              >
                <div class="mb-2 flex items-center gap-2">
                  <Icon class="text-theme-text-secondary group-hover:text-theme-accent h-4 w-4 transition-colors" />
                  <span class="text-theme-text-secondary text-xs">{tile.label}</span>
                </div>
                <p class="text-theme-text group-hover:text-theme-accent truncate text-sm font-medium transition-colors">
                  {tile.title}
                </p>
                <p class="text-theme-text-secondary truncate text-xs">{tile.subtitle}</p>
              </Tag>
            );
          })
        }
      </div>
    </section>

    <!-- Experience Section -->
    <section class="mb-10">
      <div class="mb-6 flex items-center gap-4">
        <h2 class="text-theme-text section-heading text-lg font-medium">Experience</h2>
        <div class="bg-theme-border border-theme-border h-px flex-grow border-b border-dotted">
        </div>
      </div>

      <div class="space-y-4">
        {
          experience.map((exp) => {
            const companySlug = exp.company
              .toLowerCase()
              .replace(/\s+/g, '-')
              .replace(/[^a-z0-9-]/g, '');
            const currentPosition = exp.positions[0];
            const companyStart = exp.positions[exp.positions.length - 1].startDate;
            return (
              <a
                href={`/experience/#${companySlug}`}
                class="group -mx-2 flex items-start justify-between rounded-lg px-2 py-1 transition-colors"
              >
                <div>
                  <span class="text-theme-text hover-underline">{currentPosition.title}</span>
                  <p class="text-theme-text-secondary text-sm">{exp.company}</p>
                  {currentPosition.built && (
                    <p class="text-theme-text-muted mt-1 text-xs italic">{currentPosition.built}</p>
                  )}
                </div>
                <span class="text-theme-text-secondary ml-4 shrink-0 font-mono text-sm">
                  {companyStart} —{' '}
                  {currentPosition.endDate === 'Present' ? 'now' : currentPosition.endDate}
                </span>
              </a>
            );
          })
        }

        <div class="pt-2">
          <a
            href="/experience/"
            class="text-theme-text-secondary arrow-link text-sm"
            data-umami-event="read-more"
            data-umami-event-section="experience"
          >
            <span class="arrow">→</span><span class="text">all experience</span>
          </a>
        </div>
      </div>
    </section>

    <!-- Writing Section -->
    <section class="mb-10">
      <div class="mb-6 flex items-center gap-4">
        <h2 class="text-theme-text section-heading text-lg font-medium">Writing</h2>
        <div class="bg-theme-border border-theme-border h-px flex-grow border-b border-dotted">
        </div>
      </div>

      <div class="space-y-4">
        {
          blogPosts.map((post) => {
            const postUrl = post.data.externalUrl || `/blog/${post.slug}/`;
            const isExternal = !!post.data.externalUrl;
            return (
              <article class="group flex items-baseline justify-between">
                <a
                  href={postUrl}
                  target={isExternal ? '_blank' : undefined}
                  class="hover-underline text-theme-text"
                  data-umami-event="blog-click"
                  data-umami-event-title={post.data.title}
                >
                  {post.data.title}
                </a>
                <span class="text-theme-text-secondary ml-4 shrink-0 font-mono text-sm">
                  {post.data.readingTime || 5} min
                </span>
              </article>
            );
          })
        }

        <div class="pt-2">
          <a
            href="/blog/"
            class="text-theme-text-secondary arrow-link text-sm"
            data-umami-event="read-more"
            data-umami-event-section="blog"
          >
            <span class="arrow">→</span><span class="text">all writing</span>
          </a>
        </div>
      </div>
    </section>

    <!-- Quote -->
    <blockquote id="quote" class="border-theme-accent/40 mb-10 border-l-2 pl-4 text-sm">
      <p id="quote-text" class="text-theme-text-secondary italic">
        "{quotes[0].text}"
      </p>
      <cite id="quote-author" class="text-theme-text-muted text-xs not-italic">
        — {quotes[0].author}
      </cite>
    </blockquote>

    <!-- Talks Section -->
    <section class="mb-10">
      <div class="mb-6 flex items-center gap-4">
        <h2 class="text-theme-text section-heading text-lg font-medium">Talks</h2>
        <div class="bg-theme-border border-theme-border h-px flex-grow border-b border-dotted">
        </div>
      </div>

      <div class="space-y-4">
        {
          speaking
            .filter((talk) => talk.featured)
            .map((talk) => (
              <article class="group flex items-start justify-between">
                <div>
                  {talk.link ? (
                    <a
                      href={talk.link}
                      target="_blank"
                      class="hover-underline text-theme-text block"
                      data-umami-event="talk-click"
                      data-umami-event-title={talk.title}
                    >
                      {talk.title}
                    </a>
                  ) : (
                    <span class="text-theme-text">{talk.title}</span>
                  )}
                  <p class="text-theme-text-secondary text-sm">{talk.event}</p>
                </div>
                <span class="text-theme-accent bg-theme-accent-bg ml-4 shrink-0 rounded px-2 py-0.5 text-xs">
                  {talk.type}
                </span>
              </article>
            ))
        }

        <div class="pt-2">
          <a
            href="/talks/"
            class="text-theme-text-secondary arrow-link text-sm"
            data-umami-event="read-more"
            data-umami-event-section="talks"
          >
            <span class="arrow">→</span><span class="text">all talks</span>
          </a>
        </div>
      </div>
    </section>

    <!-- Projects Section -->
    <section class="mb-10">
      <div class="mb-6 flex items-center gap-4">
        <h2 class="text-theme-text section-heading text-lg font-medium">Projects</h2>
        <div class="bg-theme-border border-theme-border h-px flex-grow border-b border-dotted">
        </div>
      </div>

      <div class="space-y-4">
        {
          projects
            .filter((project) => project.featured)
            .map((project) => (
              <article class="group flex items-baseline justify-between">
                <div>
                  <a
                    href={project.url || '#'}
                    class="text-theme-text hover-underline inline font-medium"
                    target="_blank"
                    data-umami-event="project-click"
                    data-umami-event-name={project.name}
                  >
                    {project.name}
                  </a>
                  <p class="text-theme-text-secondary text-sm">{project.description}</p>
                </div>
                {project.stars !== undefined && (
                  <span class="text-theme-highlight ml-4 shrink-0 text-xs">★ {project.stars}</span>
                )}
              </article>
            ))
        }

        <div class="pt-2">
          <a
            href="/projects/"
            class="text-theme-text-secondary arrow-link text-sm"
            data-umami-event="read-more"
            data-umami-event-section="projects"
          >
            <span class="arrow">→</span><span class="text">all projects</span>
          </a>
        </div>
      </div>
    </section>

    <!-- Notes Section -->
    <section class="mb-10">
      <div class="mb-6 flex items-center gap-4">
        <h2 class="text-theme-text section-heading text-lg font-medium">Notes</h2>
        <div class="bg-theme-border border-theme-border h-px flex-grow border-b border-dotted">
        </div>
      </div>

      <div class="space-y-3">
        {
          notes.map((note) => (
            <article class="group flex items-baseline justify-between">
              <a
                href={`/notes/${note.slug}/`}
                class="hover-underline text-theme-text text-sm"
                data-umami-event="note-click"
                data-umami-event-title={note.data.title}
              >
                {note.data.title}
              </a>
              <span class="text-theme-text-secondary ml-4 shrink-0 font-mono text-xs">
                {formatDate(note.data.publishedAt)}
              </span>
            </article>
          ))
        }

        <div class="pt-2">
          <a
            href="/notes/"
            class="text-theme-text-secondary arrow-link text-sm"
            data-umami-event="read-more"
            data-umami-event-section="notes"
          >
            <span class="arrow">→</span><span class="text">all notes</span>
          </a>
        </div>
      </div>
    </section>

    <!-- GitHub Activity -->
    <section class="mb-10">
      <div class="mb-6 flex items-center gap-4">
        <h2 class="text-theme-text section-heading text-lg font-medium">Activity</h2>
        <div class="bg-theme-border border-theme-border h-px flex-grow border-b border-dotted">
        </div>
      </div>

      <a
        href={`https://github.com/${githubUsername}`}
        target="_blank"
        class="group bg-theme-card/30 block aspect-[53/7] overflow-hidden rounded"
        data-umami-event="github-activity-click"
      >
        <img
          src={`https://ghchart.rshah.org/${githubChartColor}/${githubUsername}`}
          alt={`GitHub contribution graph for ${githubUsername}`}
          class="h-full w-full object-contain opacity-80 transition-opacity group-hover:opacity-100"
          loading="lazy"
        />
      </a>
    </section>

    <!-- Footer -->
    <footer
      class="text-theme-text-secondary border-theme-border border-t border-dotted pt-8 text-center text-sm"
    >
      <p id="footer-text" class="footer-text">
        {footerJokes[Math.floor(Math.random() * footerJokes.length)]}
      </p>
      <p id="konami-hint" class="konami-hint mt-3"></p>
    </footer>
  </main>
</BaseLayout>
