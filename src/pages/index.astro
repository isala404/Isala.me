---
import BaseLayout from '../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';
import { profileInfo as profile, experience, projects, nowTiles, quotes, footerJokes } from '../lib/profile';
import { Headphones, Coffee, Tv, Flame, Cpu, Laptop } from 'lucide-astro';

const blogPosts = (await getCollection('blog', ({ data }) => !data.draft))
  .sort((a, b) => b.data.publishedAt.valueOf() - a.data.publishedAt.valueOf())
  .slice(0, 3);

const notes = (await getCollection('notes', ({ data }) => !data.draft))
  .sort((a, b) => b.data.publishedAt.valueOf() - a.data.publishedAt.valueOf())
  .slice(0, 3);

const iconMap: Record<string, any> = {
  Headphones,
  Coffee,
  Tv,
  Flame,
  Cpu,
  Laptop,
};

function formatDate(date: Date): string {
  return date.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
}
---

<BaseLayout title="Isala Piyarisi | Observability Engineer & eBPF Enthusiast">
  <main class="max-w-content relative z-10 mx-auto px-6 py-16 md:py-24">
    <!-- Hero Section -->
    <header class="mb-12">
      <div class="flex items-start justify-between gap-4">
        <div>
          <h1
            class="text-summer-text relative mb-2 text-3xl font-semibold tracking-tight md:text-4xl"
          >
            <span id="name-text" class="name-clickable">{profile.name}</span>
            <span id="name-tooltip" class="name-tooltip">stop that!</span>
          </h1>
          <p class="text-summer-text-secondary mb-4 text-lg font-medium">
            {profile.title} · {profile.tagline}
          </p>
        </div>
        <div class="dog-container h-20 w-20 flex-shrink-0 md:h-24 md:w-24">
          <img src="/dog-still.png" alt="A cute golden retriever" class="dog-still" />
          <div class="dog-sprite" aria-hidden="true"></div>
        </div>
      </div>
      <nav class="mb-6 flex items-center gap-4 text-sm font-medium">
        <a
          href={`mailto:${profile.email}`}
          class="text-summer-accent hover:text-summer-accent-hover transition-colors"
          title={profile.email}>em</a
        >
        <span class="text-summer-text-secondary">·</span>
        <a
          href={profile.github}
          class="text-summer-accent hover:text-summer-accent-hover transition-colors">gh</a
        >
        <span class="text-summer-text-secondary">·</span>
        <a
          href={profile.twitter}
          class="text-summer-accent hover:text-summer-accent-hover transition-colors">x</a
        >
        <span class="text-summer-text-secondary">·</span>
        <a
          href={profile.linkedin}
          class="text-summer-accent hover:text-summer-accent-hover transition-colors">li</a
        >
      </nav>
      <p class="text-summer-text mb-4 max-w-prose text-base leading-relaxed">
        {profile.bio}
      </p>
      <p>
        <a href="/about" class="text-summer-text-secondary arrow-link text-sm">
          <span class="arrow">→</span><span class="text">the long version</span>
        </a>
      </p>
    </header>

    <!-- Now Grid -->
    <section class="mb-12">
      <div class="now-grid grid grid-cols-2 gap-3 md:grid-cols-3">
        {
          nowTiles.map((tile) => {
            const Icon = iconMap[tile.icon];
            const Tag = tile.link ? 'a' : 'div';
            return (
              <Tag
                href={tile.link}
                target={tile.link ? '_blank' : undefined}
                data-tile={tile.id}
                class="now-tile group border-summer-text/5 bg-summer-text/[0.02] hover:bg-summer-text/[0.04] hover:border-summer-accent/20 rounded-lg border p-4 transition-all"
              >
                <div class="mb-2 flex items-center gap-2">
                  <Icon class="text-summer-text-secondary group-hover:text-summer-accent h-4 w-4 transition-colors" />
                  <span class="text-summer-text-secondary text-xs">{tile.label}</span>
                </div>
                <p class="text-summer-text group-hover:text-summer-accent truncate text-sm font-medium transition-colors">
                  {tile.title}
                </p>
                <p class="text-summer-text-secondary truncate text-xs">{tile.subtitle}</p>
              </Tag>
            );
          })
        }
      </div>
    </section>

    <!-- Experience Section -->
    <section class="mb-10">
      <div class="mb-6 flex items-center gap-4">
        <h2 class="text-summer-text section-heading text-lg font-medium">Experience</h2>
        <div class="bg-summer-text/10 border-summer-text/30 h-px flex-grow border-b border-dotted">
        </div>
      </div>

      <div class="space-y-4">
        {
          experience.slice(0, 2).map((exp) => (
            <article class="group flex items-start justify-between">
              <div>
                <span class="text-summer-text hover-underline block">{exp.positions[0].title}</span>
                <p class="text-summer-text-secondary text-sm">{exp.company}</p>
              </div>
              <span class="text-summer-text-secondary ml-4 shrink-0 font-mono text-sm">
                {exp.positions[0].startDate} —{' '}
                {exp.positions[0].endDate === 'Present' ? 'now' : exp.positions[0].endDate}
              </span>
            </article>
          ))
        }

        <div class="pt-2">
          <a href="/experience" class="text-summer-text-secondary arrow-link text-sm">
            <span class="arrow">→</span><span class="text">all experience</span>
          </a>
        </div>
      </div>
    </section>

    <!-- Writing Section -->
    <section class="mb-10">
      <div class="mb-6 flex items-center gap-4">
        <h2 class="text-summer-text section-heading text-lg font-medium">Writing</h2>
        <div class="bg-summer-text/10 border-summer-text/30 h-px flex-grow border-b border-dotted">
        </div>
      </div>

      <div class="space-y-4">
        {
          blogPosts.map((post) => (
            <article class="group flex items-baseline justify-between">
              <a href={`/blog/${post.slug}`} class="hover-underline text-summer-text">
                {post.data.title}
              </a>
              <span class="text-summer-text-secondary ml-4 shrink-0 font-mono text-sm">
                {post.data.readingTime || 5} min
              </span>
            </article>
          ))
        }

        <div class="pt-2">
          <a href="/blog" class="text-summer-text-secondary arrow-link text-sm">
            <span class="arrow">→</span><span class="text">all writing</span>
          </a>
        </div>
      </div>
    </section>

    <!-- Quote -->
    <blockquote
      id="quote"
      class="border-summer-accent/40 mb-10 border-l-2 pl-4 text-sm"
    >
      <p id="quote-text" class="text-summer-text-secondary italic">
        "{quotes[0].text}"
      </p>
      <cite id="quote-author" class="text-summer-text/40 text-xs not-italic">
        — {quotes[0].author}
      </cite>
    </blockquote>

    <!-- Projects Section -->
    <section class="mb-10">
      <div class="mb-6 flex items-center gap-4">
        <h2 class="text-summer-text section-heading text-lg font-medium">Projects</h2>
        <div class="bg-summer-text/10 border-summer-text/30 h-px flex-grow border-b border-dotted">
        </div>
      </div>

      <div class="space-y-4">
        {
          projects.slice(0, 2).map((project) => (
            <article class="group flex items-baseline justify-between">
              <div>
                <a
                  href={project.url || '#'}
                  class="text-summer-text hover-underline block font-medium"
                  target="_blank"
                >
                  {project.name}
                </a>
                <p class="text-summer-text-secondary text-sm">{project.description}</p>
              </div>
              {project.stars && (
                <span class="text-summer-golden ml-4 shrink-0 text-xs">★ {project.stars}</span>
              )}
            </article>
          ))
        }

        <div class="pt-2">
          <a href="/projects" class="text-summer-text-secondary arrow-link text-sm">
            <span class="arrow">→</span><span class="text">all projects</span>
          </a>
        </div>
      </div>
    </section>

    <!-- Notes Section -->
    <section class="mb-10">
      <div class="mb-6 flex items-center gap-4">
        <h2 class="text-summer-text section-heading text-lg font-medium">Notes</h2>
        <div class="bg-summer-text/10 border-summer-text/30 h-px flex-grow border-b border-dotted">
        </div>
      </div>

      <div class="space-y-3">
        {
          notes.map((note) => (
            <article class="group flex items-baseline justify-between">
              <a href={`/notes/${note.slug}`} class="hover-underline text-summer-text text-sm">
                {note.data.title}
              </a>
              <span class="text-summer-text-secondary ml-4 shrink-0 font-mono text-xs">
                {formatDate(note.data.publishedAt)}
              </span>
            </article>
          ))
        }

        <div class="pt-2">
          <a href="/notes" class="text-summer-text-secondary arrow-link text-sm">
            <span class="arrow">→</span><span class="text">all notes</span>
          </a>
        </div>
      </div>
    </section>

    <!-- GitHub Activity -->
    <section class="mb-10">
      <div class="mb-6 flex items-center gap-4">
        <h2 class="text-summer-text section-heading text-lg font-medium">Activity</h2>
        <div class="bg-summer-text/10 border-summer-text/30 h-px flex-grow border-b border-dotted">
        </div>
      </div>

      <a
        href="https://github.com/isala404"
        target="_blank"
        class="group bg-summer-text/[0.02] block aspect-[53/7] overflow-hidden rounded"
      >
        <img
          src="https://ghchart.rshah.org/e85a3c/isala404"
          alt="GitHub contribution graph for isala404"
          class="h-full w-full object-contain opacity-80 transition-opacity group-hover:opacity-100"
          loading="lazy"
        />
      </a>
    </section>

    <!-- Footer -->
    <footer
      class="text-summer-text-secondary border-summer-text/20 border-t border-dotted pt-8 text-center text-sm"
    >
      <p id="footer-text" class="footer-text">
        {footerJokes[0]}
      </p>
      <p id="konami-hint" class="konami-hint mt-3">↑↑↓↓←→←→BA</p>
    </footer>
  </main>
</BaseLayout>
