---
import BaseLayout from '../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';
import { profile, experience, projects, nowTiles, quotes, footerJokes } from '../data/profile';
import { Headphones, Coffee, Tv, Flame, Cpu, Laptop } from 'lucide-astro';

const blogPosts = (await getCollection('blog', ({ data }) => !data.draft))
  .sort((a, b) => b.data.publishedAt.valueOf() - a.data.publishedAt.valueOf())
  .slice(0, 3);

const notes = (await getCollection('notes', ({ data }) => !data.draft))
  .sort((a, b) => b.data.publishedAt.valueOf() - a.data.publishedAt.valueOf())
  .slice(0, 3);

const iconMap: Record<string, any> = {
  Headphones,
  Coffee,
  Tv,
  Flame,
  Cpu,
  Laptop,
};

function formatDate(date: Date): string {
  return date.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
}
---

<BaseLayout title="Isala Piyarisi | Observability Engineer & eBPF Enthusiast">
  <main class="max-w-content mx-auto px-6 py-16 md:py-24 relative z-10">
    <!-- Hero Section -->
    <header class="mb-12 fade-in fade-in-delay-1">
      <div class="flex items-start justify-between gap-4">
        <div>
          <h1 class="text-3xl md:text-4xl font-semibold text-summer-text mb-2 tracking-tight relative">
            <span id="name-text" class="name-clickable">{profile.name}</span>
            <span id="name-tooltip" class="name-tooltip">stop that!</span>
          </h1>
          <p class="text-lg text-summer-text-secondary mb-4 font-medium">
            {profile.title} · {profile.tagline}
          </p>
        </div>
        <div class="dog-container w-20 h-20 md:w-24 md:h-24 flex-shrink-0">
          <img src="/dog-still.png" alt="A cute golden retriever" class="dog-still" />
          <div class="dog-sprite" aria-hidden="true"></div>
        </div>
      </div>
      <nav class="flex gap-4 text-sm font-medium items-center mb-6">
        <a href={`mailto:${profile.email}`} class="text-summer-accent hover:text-summer-accent-hover transition-colors" title={profile.email}>em</a>
        <span class="text-summer-text-secondary">·</span>
        <a href={profile.github} class="text-summer-accent hover:text-summer-accent-hover transition-colors">gh</a>
        <span class="text-summer-text-secondary">·</span>
        <a href={profile.twitter} class="text-summer-accent hover:text-summer-accent-hover transition-colors">x</a>
        <span class="text-summer-text-secondary">·</span>
        <a href={profile.linkedin} class="text-summer-accent hover:text-summer-accent-hover transition-colors">li</a>
      </nav>
      <p class="text-base text-summer-text leading-relaxed max-w-prose mb-4">
        {profile.bio}
      </p>
      <p>
        <a href="/about" class="text-sm text-summer-text-secondary arrow-link">
          <span class="arrow">→</span><span class="text">the long version</span>
        </a>
      </p>
    </header>

    <!-- Now Grid -->
    <section class="mb-12 fade-in fade-in-delay-2">
      <div class="now-grid grid grid-cols-2 md:grid-cols-3 gap-3">
        {nowTiles.map((tile) => {
          const Icon = iconMap[tile.icon];
          const Tag = tile.link ? 'a' : 'div';
          return (
            <Tag
              href={tile.link}
              target={tile.link ? "_blank" : undefined}
              data-tile={tile.id}
              class="now-tile group p-4 rounded-lg border border-summer-text/5 bg-summer-text/[0.02] hover:bg-summer-text/[0.04] hover:border-summer-accent/20 transition-all"
            >
              <div class="flex items-center gap-2 mb-2">
                <Icon class="w-4 h-4 text-summer-text-secondary group-hover:text-summer-accent transition-colors" />
                <span class="text-xs text-summer-text-secondary">{tile.label}</span>
              </div>
              <p class="text-sm font-medium text-summer-text group-hover:text-summer-accent transition-colors truncate">
                {tile.title}
              </p>
              <p class="text-xs text-summer-text-secondary truncate">{tile.subtitle}</p>
            </Tag>
          );
        })}
      </div>
    </section>

    <!-- Experience Section -->
    <section class="mb-10 fade-in fade-in-delay-2">
      <div class="flex items-center gap-4 mb-6">
        <h2 class="text-lg font-medium text-summer-text section-heading">Experience</h2>
        <div class="h-px bg-summer-text/10 flex-grow border-b border-dotted border-summer-text/30"></div>
      </div>

      <div class="space-y-4">
        {experience.slice(0, 2).map((exp) => (
          <article class="flex justify-between items-start group">
            <div>
              <span class="text-summer-text hover-underline block">{exp.positions[0].title}</span>
              <p class="text-sm text-summer-text-secondary">{exp.company}</p>
            </div>
            <span class="text-sm text-summer-text-secondary font-mono shrink-0 ml-4">
              {exp.positions[0].startDate} — {exp.positions[0].endDate === 'Present' ? 'now' : exp.positions[0].endDate}
            </span>
          </article>
        ))}

        <div class="pt-2">
          <a href="/experience" class="text-sm text-summer-text-secondary arrow-link">
            <span class="arrow">→</span><span class="text">all experience</span>
          </a>
        </div>
      </div>
    </section>

    <!-- Writing Section -->
    <section class="mb-10 fade-in fade-in-delay-2">
      <div class="flex items-center gap-4 mb-6">
        <h2 class="text-lg font-medium text-summer-text section-heading">Writing</h2>
        <div class="h-px bg-summer-text/10 flex-grow border-b border-dotted border-summer-text/30"></div>
      </div>

      <div class="space-y-4">
        {blogPosts.map((post) => (
          <article class="flex justify-between items-baseline group">
            <a href={`/blog/${post.slug}`} class="hover-underline text-summer-text">
              {post.data.title}
            </a>
            <span class="text-sm text-summer-text-secondary font-mono shrink-0 ml-4">
              {post.data.readingTime || 5} min
            </span>
          </article>
        ))}

        <div class="pt-2">
          <a href="/blog" class="text-sm text-summer-text-secondary arrow-link">
            <span class="arrow">→</span><span class="text">all writing</span>
          </a>
        </div>
      </div>
    </section>

    <!-- Quote -->
    <blockquote id="quote" class="mb-10 fade-in fade-in-delay-3 text-sm border-l-2 border-summer-accent/40 pl-4">
      <p id="quote-text" class="text-summer-text-secondary italic">
        "{quotes[0].text}"
      </p>
      <cite id="quote-author" class="text-xs text-summer-text/40 not-italic">
        — {quotes[0].author}
      </cite>
    </blockquote>

    <!-- Projects Section -->
    <section class="mb-10 fade-in fade-in-delay-3">
      <div class="flex items-center gap-4 mb-6">
        <h2 class="text-lg font-medium text-summer-text section-heading">Projects</h2>
        <div class="h-px bg-summer-text/10 flex-grow border-b border-dotted border-summer-text/30"></div>
      </div>

      <div class="space-y-4">
        {projects.slice(0, 2).map((project) => (
          <article class="group flex justify-between items-baseline">
            <div>
              <a href={project.url || '#'} class="font-medium text-summer-text hover-underline block" target="_blank">
                {project.name}
              </a>
              <p class="text-sm text-summer-text-secondary">{project.description}</p>
            </div>
            {project.stars && (
              <span class="text-xs text-summer-golden shrink-0 ml-4">★ {project.stars}</span>
            )}
          </article>
        ))}

        <div class="pt-2">
          <a href="/projects" class="text-sm text-summer-text-secondary arrow-link">
            <span class="arrow">→</span><span class="text">all projects</span>
          </a>
        </div>
      </div>
    </section>

    <!-- Notes Section -->
    <section class="mb-10 fade-in fade-in-delay-4">
      <div class="flex items-center gap-4 mb-6">
        <h2 class="text-lg font-medium text-summer-text section-heading">Notes</h2>
        <div class="h-px bg-summer-text/10 flex-grow border-b border-dotted border-summer-text/30"></div>
      </div>

      <div class="space-y-3">
        {notes.map((note) => (
          <article class="flex justify-between items-baseline group">
            <a href={`/notes/${note.slug}`} class="hover-underline text-summer-text text-sm">
              {note.data.title}
            </a>
            <span class="text-xs text-summer-text-secondary font-mono shrink-0 ml-4">
              {formatDate(note.data.publishedAt)}
            </span>
          </article>
        ))}

        <div class="pt-2">
          <a href="/notes" class="text-sm text-summer-text-secondary arrow-link">
            <span class="arrow">→</span><span class="text">all notes</span>
          </a>
        </div>
      </div>
    </section>

    <!-- GitHub Activity -->
    <section class="mb-10 fade-in fade-in-delay-4">
      <div class="flex items-center gap-4 mb-6">
        <h2 class="text-lg font-medium text-summer-text section-heading">Activity</h2>
        <div class="h-px bg-summer-text/10 flex-grow border-b border-dotted border-summer-text/30"></div>
      </div>

      <a
        href="https://github.com/Supiri"
        target="_blank"
        class="block group aspect-[53/7] bg-summer-text/[0.02] rounded overflow-hidden"
      >
        <img
          src="https://ghchart.rshah.org/e85a3c/Supiri"
          alt="GitHub contribution graph for Supiri"
          class="w-full h-full object-contain opacity-80 group-hover:opacity-100 transition-opacity"
          loading="lazy"
        />
      </a>
    </section>

    <!-- Footer -->
    <footer class="text-sm text-summer-text-secondary fade-in fade-in-delay-4 border-t border-dotted border-summer-text/20 pt-8 text-center">
      <p id="footer-text" class="footer-text">
        {footerJokes[0]}
      </p>
      <p id="konami-hint" class="konami-hint mt-3">↑↑↓↓←→←→BA</p>
    </footer>
  </main>
</BaseLayout>
