---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';

export async function getStaticPaths() {
  const posts = await getCollection('blog');
  return posts.map((post) => ({
    params: { slug: post.slug },
    props: { post },
  }));
}

const { post } = Astro.props;
const { Content } = await post.render();

function formatDate(date: Date): string {
  return date.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
}
---

<BaseLayout
  title={`${post.data.title} | Isala Piyarisi`}
  description={post.data.description}
  image={post.data.cover}
  type="article"
  publishedTime={post.data.publishedAt.toISOString()}
>
  <!-- Track article read -->
  <script is:inline define:vars={{ postTitle: post.data.title, postSlug: post.slug }}>
    if (typeof umami !== 'undefined') {
      umami.track('article-view', { title: postTitle, slug: postSlug });
    } else {
      window.addEventListener('load', () => {
        setTimeout(() => {
          if (typeof umami !== 'undefined') {
            umami.track('article-view', { title: postTitle, slug: postSlug });
          }
        }, 500);
      });
    }
  </script>
  <main class="max-w-content relative z-10 mx-auto px-6 py-16 md:py-24">
    <!-- Header -->
    <header class="mb-10">
      <a href="/blog" class="text-theme-text-secondary arrow-link mb-6 inline-block text-sm">
        <span class="arrow">←</span><span class="text">all writing</span>
      </a>

      <h1
        class="text-theme-text mb-4 text-2xl leading-tight font-semibold tracking-tight md:text-3xl"
      >
        {post.data.title}
      </h1>

      <div class="text-theme-text-secondary flex flex-wrap items-center gap-4 text-sm">
        <time datetime={post.data.publishedAt.toISOString()}>
          {formatDate(post.data.publishedAt)}
        </time>
        <span>·</span>
        <span>{post.data.readingTime || 5} min read</span>
        {
          post.data.tags && post.data.tags.length > 0 && (
            <>
              <span>·</span>
              <div class="flex gap-2">
                {post.data.tags.map((tag) => (
                  <a
                    href={`/blog/tag/${tag}`}
                    class="bg-theme-card border-theme-border hover:bg-theme-accent-bg hover:text-theme-accent hover:border-theme-border-hover rounded border px-2 py-0.5 text-xs transition-colors"
                  >
                    {tag}
                  </a>
                ))}
              </div>
            </>
          )
        }
      </div>
    </header>

    <!-- Cover Image -->
    {
      post.data.cover && (
        <div class="-mx-6 mb-10 md:-mx-0">
          <img
            src={post.data.cover}
            alt={post.data.title}
            class="h-auto w-full rounded-lg"
            loading="eager"
          />
        </div>
      )
    }

    <!-- Content -->
    <article class="prose prose-summer max-w-none">
      <Content />
    </article>
  </main>
</BaseLayout>

<style is:global>
  /* Blog prose styling - uses CSS variables for theming */
  .prose-summer {
    color: var(--theme-text);
  }

  .prose-summer h2 {
    font-size: 1.375rem;
    font-weight: 700;
    margin-top: 2.5rem;
    margin-bottom: 1rem;
    color: var(--theme-text);
    letter-spacing: -0.01em;
  }

  .prose-summer h3 {
    font-size: 1.125rem;
    font-weight: 600;
    margin-top: 2rem;
    margin-bottom: 0.75rem;
    color: var(--theme-text);
  }

  .prose-summer p {
    font-size: 1rem;
    line-height: 1.75;
    margin-bottom: 1rem;
  }

  .prose-summer a {
    color: var(--theme-accent);
    text-decoration: underline;
    text-decoration-color: var(--theme-border-hover);
    text-underline-offset: 2px;
    transition: text-decoration-color 0.2s;
  }

  .prose-summer a:hover {
    text-decoration-color: var(--theme-accent);
  }

  .prose-summer code:not(pre code) {
    padding: 0.125rem 0.375rem;
    border-radius: 0.25rem;
    background: var(--theme-accent-bg);
    font-size: 0.875rem;
    font-family: 'JetBrains Mono', monospace;
    color: var(--theme-accent);
  }

  .prose-summer pre {
    border-radius: 0.5rem;
    padding: 1rem;
    overflow-x: auto;
    font-size: 0.875rem;
    white-space: pre;
    scrollbar-width: thin;
    scrollbar-color: var(--theme-scrollbar-thumb) transparent;
    border: 1px solid var(--theme-border);
  }

  .prose-summer pre::-webkit-scrollbar {
    height: 4px;
  }

  .prose-summer pre::-webkit-scrollbar-track {
    background: transparent;
  }

  .prose-summer pre::-webkit-scrollbar-thumb {
    background: var(--theme-scrollbar-thumb);
    border-radius: 2px;
  }

  .prose-summer pre::-webkit-scrollbar-thumb:hover {
    background: var(--theme-scrollbar-thumb-hover);
  }

  .prose-summer pre code {
    background: none;
    padding: 0;
    color: inherit;
    white-space: pre;
    word-wrap: normal;
    overflow-wrap: normal;
  }

  .prose-summer blockquote {
    border-left: none;
    padding: 1rem 0 1rem 3rem;
    margin: 2rem 0;
    font-style: normal;
    color: var(--theme-text);
    position: relative;
  }

  .prose-summer blockquote::before {
    content: '"';
    position: absolute;
    left: 0;
    top: 0;
    font-size: 4rem;
    line-height: 1;
    color: var(--theme-border-hover);
    font-family: Georgia, serif;
  }

  .prose-summer blockquote p {
    font-size: 1.125rem;
    line-height: 1.6;
    font-weight: 400;
    margin-bottom: 0.5rem;
  }

  .prose-summer blockquote p:last-child {
    font-size: 0.9rem;
    color: var(--theme-text-secondary);
    margin-bottom: 0;
  }

  .prose-summer blockquote a {
    color: var(--theme-accent);
  }

  /* Code block wrapper with copy button */
  .prose-summer .code-wrapper {
    position: relative;
  }

  .prose-summer .copy-btn {
    position: absolute;
    top: 0.5rem;
    right: 0.5rem;
    padding: 0.25rem 0.5rem;
    font-size: 0.75rem;
    font-family: 'JetBrains Mono', monospace;
    background: var(--theme-bg);
    color: var(--theme-text-secondary);
    border: 1px solid var(--theme-border);
    border-radius: 0.25rem;
    cursor: pointer;
    transition:
      background 0.2s,
      color 0.2s;
  }

  .prose-summer .copy-btn:hover {
    background: var(--theme-accent-bg);
    color: var(--theme-accent);
  }

  /* Collapsible code blocks */
  .prose-summer .code-wrapper.collapsed pre {
    max-height: 450px;
    overflow: hidden;
  }

  .prose-summer .code-wrapper.expanded pre {
    max-height: none;
  }

  .prose-summer .code-fade {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 100px;
    background: linear-gradient(to bottom, transparent, #24292e 85%);
    border-radius: 0 0 0.5rem 0.5rem;
    pointer-events: none;
    display: flex;
    align-items: flex-end;
    justify-content: center;
    padding-bottom: 0.75rem;
  }

  .prose-summer .code-wrapper.expanded .code-fade {
    background: linear-gradient(to bottom, transparent, #24292e);
    height: 60px;
  }

  .prose-summer .expand-btn {
    padding: 0.375rem 1rem;
    font-size: 0.75rem;
    font-family: 'JetBrains Mono', monospace;
    background: var(--theme-accent);
    color: var(--theme-bg);
    border: none;
    border-radius: 0.25rem;
    cursor: pointer;
    pointer-events: auto;
    transition:
      background 0.2s,
      transform 0.2s;
  }

  .prose-summer .expand-btn:hover {
    background: var(--theme-accent-hover);
    transform: translateY(-1px);
  }

  /* Image lightbox */
  .prose-summer figure img {
    cursor: zoom-in;
    transition: transform 0.2s;
  }

  .lightbox-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.9);
    z-index: 9999;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: zoom-out;
    opacity: 0;
    visibility: hidden;
    transition:
      opacity 0.3s,
      visibility 0.3s;
  }

  .lightbox-overlay.active {
    opacity: 1;
    visibility: visible;
  }

  .lightbox-overlay img {
    max-width: 90%;
    max-height: 90%;
    object-fit: contain;
    border-radius: 0.5rem;
    transform: scale(0.9);
    transition: transform 0.3s;
  }

  .lightbox-overlay.active img {
    transform: scale(1);
  }

  .prose-summer ul {
    list-style-type: disc;
    padding-left: 1.5rem;
    margin: 1rem 0;
  }

  .prose-summer ul li {
    margin: 0.5rem 0;
  }

  .prose-summer ul li::marker {
    color: var(--theme-accent);
  }

  .prose-summer ol {
    list-style-type: decimal;
    padding-left: 1.5rem;
    margin: 1rem 0;
  }

  .prose-summer ol li {
    margin: 0.5rem 0;
  }

  /* Images with captions - centered */
  .prose-summer img {
    border-radius: 0.5rem;
    margin-bottom: 0.5rem;
    display: block;
    margin-left: auto;
    margin-right: auto;
  }

  .prose-summer figure {
    margin: 1.5rem 0;
  }

  .prose-summer figcaption {
    font-size: 0.8rem;
    color: var(--theme-text-secondary);
    margin-top: 0.75rem;
    text-align: center;
  }

  .prose-summer strong {
    font-weight: 600;
    color: var(--theme-text);
  }

  .prose-summer hr {
    border-color: var(--theme-border);
    margin: 2rem 0;
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    // Add captions to images based on alt text
    const images = document.querySelectorAll('.prose-summer img[alt]');
    images.forEach((img) => {
      const alt = img.getAttribute('alt');
      if (alt && alt.trim() !== '') {
        const figure = document.createElement('figure');
        const figcaption = document.createElement('figcaption');
        figcaption.textContent = alt;

        img.parentNode?.insertBefore(figure, img);
        figure.appendChild(img);
        figure.appendChild(figcaption);
      }
    });

    // Open external links in new tab
    const links = document.querySelectorAll('.prose-summer a[href^="http"]');
    links.forEach((link) => {
      link.setAttribute('target', '_blank');
      link.setAttribute('rel', 'noopener noreferrer');
    });

    // Add copy button and collapse functionality to code blocks
    const codeBlocks = document.querySelectorAll('.prose-summer pre');
    const COLLAPSE_THRESHOLD = 450;

    codeBlocks.forEach((pre) => {
      const wrapper = document.createElement('div');
      wrapper.className = 'code-wrapper';
      pre.parentNode?.insertBefore(wrapper, pre);
      wrapper.appendChild(pre);

      // Add copy button
      const copyBtn = document.createElement('button');
      copyBtn.className = 'copy-btn';
      copyBtn.textContent = 'copy';
      wrapper.appendChild(copyBtn);

      copyBtn.addEventListener('click', async () => {
        const code = pre.querySelector('code')?.textContent || pre.textContent || '';
        await navigator.clipboard.writeText(code);
        copyBtn.textContent = 'copied!';
        setTimeout(() => {
          copyBtn.textContent = 'copy';
        }, 2000);
      });

      // Add collapse functionality for long code blocks
      if (pre.scrollHeight > COLLAPSE_THRESHOLD) {
        wrapper.classList.add('collapsed');

        const fadeOverlay = document.createElement('div');
        fadeOverlay.className = 'code-fade';

        const expandBtn = document.createElement('button');
        expandBtn.className = 'expand-btn';
        expandBtn.textContent = 'show more';
        fadeOverlay.appendChild(expandBtn);
        wrapper.appendChild(fadeOverlay);

        expandBtn.addEventListener('click', () => {
          const isCollapsed = wrapper.classList.contains('collapsed');
          if (isCollapsed) {
            wrapper.classList.remove('collapsed');
            wrapper.classList.add('expanded');
            expandBtn.textContent = 'show less';
          } else {
            wrapper.classList.remove('expanded');
            wrapper.classList.add('collapsed');
            expandBtn.textContent = 'show more';
            // Scroll to top of code block when collapsing
            wrapper.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
          }
        });
      }
    });

    // Image lightbox
    const lightbox = document.createElement('div');
    lightbox.className = 'lightbox-overlay';
    const lightboxImg = document.createElement('img');
    lightbox.appendChild(lightboxImg);
    document.body.appendChild(lightbox);

    const figureImages = document.querySelectorAll<HTMLImageElement>('.prose-summer figure img');
    figureImages.forEach((img) => {
      img.addEventListener('click', () => {
        lightboxImg.src = img.src;
        lightboxImg.alt = img.alt;
        lightbox.classList.add('active');
        document.body.style.overflow = 'hidden';
      });
    });

    const closeLightbox = () => {
      lightbox.classList.remove('active');
      document.body.style.overflow = '';
    };

    lightbox.addEventListener('click', closeLightbox);

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && lightbox.classList.contains('active')) {
        closeLightbox();
      }
    });
  });
</script>
