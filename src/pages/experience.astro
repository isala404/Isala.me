---
import BaseLayout from '../layouts/BaseLayout.astro';
import { ChevronDown } from 'lucide-astro';
import {
  experience,
  profileInfo as profile,
  education,
  certifications,
  publications,
} from '../lib/profile';
---

<BaseLayout
  title="Experience | Isala Piyarisi"
  description="Professional experience spanning observability engineering, DevOps, and full-stack development."
>
  <main class="max-w-content relative z-10 mx-auto px-6 py-16 md:py-24">
    <!-- Back Home -->
    <a href="/" class="text-summer-text-secondary arrow-link mb-8 inline-block text-sm">
      <span class="arrow">←</span><span class="text">back home</span>
    </a>

    <header class="mb-12">
      <h1 class="text-summer-text mb-4 text-3xl font-semibold tracking-tight md:text-4xl">
        Experience
      </h1>
      <p class="text-summer-text-secondary text-base">
        Building infrastructure and systems since 2014
      </p>
    </header>

    <!-- Skills -->
    <section class="mb-12">
      <div class="mb-6 flex items-center gap-4">
        <h2 class="text-summer-text section-heading text-lg font-medium">Top Skills</h2>
        <div class="bg-summer-text/10 border-summer-text/30 h-px flex-grow border-b border-dotted">
        </div>
      </div>
      <div class="flex flex-wrap gap-2">
        {
          profile.topSkills.map((skill) => (
            <span class="bg-summer-text/5 text-summer-text-secondary border-summer-text/10 rounded-full border px-3 py-1 text-sm">
              {skill}
            </span>
          ))
        }
      </div>
    </section>

    <!-- Work Experience -->
    <section class="mb-12">
      <div class="mb-6 flex items-center gap-4">
        <h2 class="text-summer-text section-heading text-lg font-medium">Work</h2>
        <div class="bg-summer-text/10 border-summer-text/30 h-px flex-grow border-b border-dotted">
        </div>
      </div>

      <div class="space-y-12">
        {
          experience.map((company, companyIdx) => (
            <article class="relative">
              <div class="mb-6">
                <h3 class="text-summer-text text-xl font-medium">{company.company}</h3>
              </div>

              <div class="border-summer-text/10 ml-2 space-y-6 border-l-2 pl-6">
                {company.positions.map((position, posIdx) => {
                  const positionId = `pos-${companyIdx}-${posIdx}`;
                  const hasSummary = position.summary && position.summary.length > 0;
                  const hasDetails = position.details && position.details.length > 0;
                  const hasExpandableContent = hasSummary && hasDetails;

                  return (
                    <div class="relative" data-position-id={positionId}>
                      <div class="bg-summer-bg border-summer-accent absolute top-1 -left-[31px] h-3 w-3 rounded-full border-2" />

                      <div class="mb-2 flex flex-col gap-1 md:flex-row md:items-start md:justify-between">
                        <div>
                          {hasExpandableContent ? (
                            <button
                              class="position-toggle group flex items-center gap-1.5 text-left"
                              data-target={positionId}
                              aria-expanded="false"
                            >
                              <h4 class="text-summer-text group-hover:text-summer-accent font-medium transition-colors">
                                {position.title}
                              </h4>
                              <ChevronDown class="text-summer-text-secondary group-hover:text-summer-accent h-4 w-4 transition-transform duration-200" />
                            </button>
                          ) : (
                            <h4 class="text-summer-text font-medium">{position.title}</h4>
                          )}
                          <p class="text-summer-text-secondary text-sm">
                            {position.type}
                            {position.location && <span> · {position.location}</span>}
                          </p>
                        </div>
                        <span class="text-summer-text-secondary shrink-0 font-mono text-sm">
                          {position.startDate} —{' '}
                          {position.endDate === 'Present' ? 'now' : position.endDate}
                        </span>
                      </div>

                      {/* Summary points (always visible) */}
                      {hasSummary && (
                        <ul class="text-summer-text-secondary mb-1 space-y-1 text-sm leading-relaxed">
                          {position.summary!.map((point: string) => (
                            <li class="flex items-start gap-2">
                              <span class="text-summer-accent mt-1.5 h-1 w-1 flex-shrink-0 rounded-full bg-current" />
                              <span>{point}</span>
                            </li>
                          ))}
                        </ul>
                      )}

                      {/* Additional details (expandable) */}
                      {hasDetails && (
                        <ul
                          class="details-content text-summer-text-secondary mb-3 hidden space-y-1 text-sm leading-relaxed"
                          data-details-for={positionId}
                        >
                          {position.details!.map((point: string, idx: number) => (
                            <li
                              class="details-item flex items-start gap-2"
                              style={`--delay: ${idx * 30}ms`}
                            >
                              <span class="text-summer-text-secondary/50 mt-1.5 h-1 w-1 flex-shrink-0 rounded-full bg-current" />
                              <span>{point}</span>
                            </li>
                          ))}
                        </ul>
                      )}

                      {/* Fallback for legacy description field */}
                      {!hasSummary && position.description && (
                        <ul class="text-summer-text-secondary mb-3 space-y-1 text-sm leading-relaxed">
                          {position.description
                            .split('\n')
                            .filter((line: string) => line.trim())
                            .map((line: string) => (
                              <li class="flex items-start gap-2">
                                <span class="text-summer-accent mt-1.5 h-1 w-1 flex-shrink-0 rounded-full bg-current" />
                                <span>{line.trim().replace(/^[-•]\s*/, '')}</span>
                              </li>
                            ))}
                        </ul>
                      )}

                      {position.link && (
                        <a
                          href={position.link}
                          target="_blank"
                          class="text-summer-text-secondary arrow-link mb-3 inline-block text-sm"
                        >
                          <span class="arrow">→</span>
                          <span class="text">view project</span>
                        </a>
                      )}

                      {position.skills && position.skills.length > 0 && (
                        <div class="flex flex-wrap gap-2">
                          {position.skills.map((skill) => (
                            <span class="bg-summer-text/5 text-summer-text-secondary border-summer-text/10 rounded border px-2 py-0.5 text-xs">
                              {skill}
                            </span>
                          ))}
                        </div>
                      )}
                    </div>
                  );
                })}
              </div>
            </article>
          ))
        }
      </div>
    </section>

    <!-- Education -->
    <section class="mb-12">
      <div class="mb-6 flex items-center gap-4">
        <h2 class="text-summer-text section-heading text-lg font-medium">Education</h2>
        <div class="bg-summer-text/10 border-summer-text/30 h-px flex-grow border-b border-dotted">
        </div>
      </div>

      {
        education.map((edu) => (
          <article class="mb-6">
            <div class="mb-2 flex items-start justify-between">
              <div>
                <h3 class="text-summer-text font-medium">{edu.institution}</h3>
                <p class="text-summer-text-secondary text-sm">{edu.degree}</p>
              </div>
              <span class="text-summer-text-secondary ml-4 shrink-0 font-mono text-sm">
                {edu.startDate} — {edu.endDate}
              </span>
            </div>
            {edu.grade && (
              <p class="text-summer-golden mb-2 text-sm">
                {edu.grade} · {edu.rank}
              </p>
            )}
            <ul class="space-y-1">
              {edu.highlights.map((highlight) => (
                <li class="text-summer-text-secondary flex items-start gap-2 text-sm">
                  <span class="text-summer-accent mt-1">·</span>
                  <span>{highlight}</span>
                </li>
              ))}
            </ul>
          </article>
        ))
      }
    </section>

    <!-- Certifications -->
    <section class="mb-12">
      <div class="mb-6 flex items-center gap-4">
        <h2 class="text-summer-text section-heading text-lg font-medium">Certifications</h2>
        <div class="bg-summer-text/10 border-summer-text/30 h-px flex-grow border-b border-dotted">
        </div>
      </div>

      <div class="space-y-3">
        {
          certifications.map((cert) => (
            <article class="flex items-start justify-between">
              <div>
                {cert.url ? (
                  <a href={cert.url} target="_blank" class="text-summer-text hover-underline">
                    {cert.name}
                  </a>
                ) : (
                  <span class="text-summer-text">{cert.name}</span>
                )}
                <p class="text-summer-text-secondary text-sm">{cert.issuer}</p>
              </div>
              <span class="text-summer-text-secondary ml-4 shrink-0 font-mono text-sm">
                {cert.date}
              </span>
            </article>
          ))
        }
      </div>
    </section>

    <!-- Publications -->
    <section class="mb-12">
      <div class="mb-6 flex items-center gap-4">
        <h2 class="text-summer-text section-heading text-lg font-medium">Publications</h2>
        <div class="bg-summer-text/10 border-summer-text/30 h-px flex-grow border-b border-dotted">
        </div>
      </div>

      <div class="space-y-4">
        {
          publications.map((pub) => (
            <article class="flex items-start justify-between">
              <div>
                <a href={pub.url} target="_blank" class="text-summer-text hover-underline block">
                  {pub.title}
                </a>
                <p class="text-summer-text-secondary text-sm">{pub.publisher}</p>
              </div>
              <span class="text-summer-text-secondary ml-4 shrink-0 font-mono text-sm">
                {pub.date}
              </span>
            </article>
          ))
        }
      </div>
    </section>
  </main>

  <style>
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(-8px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .details-content {
      overflow: hidden;
      transition: height 0.3s ease-out, opacity 0.2s ease-out;
    }

    .details-content.expanding .details-item {
      animation: slideIn 0.25s ease-out forwards;
      animation-delay: var(--delay, 0ms);
      opacity: 0;
    }

    .details-content.collapsing {
      opacity: 0;
    }
  </style>

  <script>
    function initToggles() {
      document.querySelectorAll('.position-toggle').forEach((button) => {
        button.addEventListener('click', () => {
          const targetId = button.getAttribute('data-target');
          if (!targetId) return;

          const isExpanded = button.getAttribute('aria-expanded') === 'true';
          const details = document.querySelector(`[data-details-for="${targetId}"]`) as HTMLElement;
          const chevron = button.querySelector('svg');
          const items = details?.querySelectorAll('.details-item');

          if (isExpanded) {
            // Collapse: animate height and opacity
            button.setAttribute('aria-expanded', 'false');
            chevron?.classList.remove('rotate-180');

            if (details) {
              // Set current height explicitly so we can animate from it
              const currentHeight = details.scrollHeight;
              details.style.height = `${currentHeight}px`;

              // Force reflow
              details.offsetHeight;

              // Start collapse animation
              details.classList.remove('expanding');
              details.classList.add('collapsing');
              details.style.height = '0px';

              // After animation, hide
              setTimeout(() => {
                details.classList.add('hidden');
                details.classList.remove('collapsing');
                details.style.height = '';
              }, 300);
            }
          } else {
            // Expand: show and animate in
            button.setAttribute('aria-expanded', 'true');
            chevron?.classList.add('rotate-180');

            if (details) {
              details.classList.remove('hidden', 'collapsing');

              // Get the target height
              details.style.height = 'auto';
              const targetHeight = details.scrollHeight;

              // Start from 0
              details.style.height = '0px';

              // Force reflow
              details.offsetHeight;

              // Animate to target height
              details.classList.add('expanding');
              details.style.height = `${targetHeight}px`;

              // Remove expanding class and height after animations complete
              const totalDuration = Math.max((items?.length || 0) * 30 + 250, 300);
              setTimeout(() => {
                details.classList.remove('expanding');
                details.style.height = '';
              }, totalDuration);
            }
          }
        });
      });
    }

    // Initialize on page load
    initToggles();

    // Re-initialize after Astro page transitions
    document.addEventListener('astro:page-load', initToggles);
  </script>
</BaseLayout>
